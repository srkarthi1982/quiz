---
import "@ansiversa/components/styles/global.css";
import { WebLayout as BaseWebLayout } from "@ansiversa/components";
import { SESSION_COOKIE_NAME } from "../lib/auth";

interface Props {
  title?: string;
  description?: string;
}

const props = Astro.props;
const locals = Astro.locals as {
  isAuthenticated?: boolean;
  rootAppUrl?: string;
  sessionToken?: string | null;
};
const rootAppUrl = locals?.rootAppUrl ?? "https://ansiversa.com";
const cookieHeader = Astro.request.headers.get("cookie") ?? "";
const sessionCookie = locals?.sessionToken
  ? `${SESSION_COOKIE_NAME}=${locals.sessionToken}`
  : "";
const outboundCookie = cookieHeader.includes(`${SESSION_COOKIE_NAME}=`)
  ? cookieHeader
  : [cookieHeader, sessionCookie].filter(Boolean).join("; ");
let notificationUnreadCount = 0;
if (locals?.isAuthenticated && outboundCookie) {
  try {
    const response = await fetch(`${rootAppUrl}/api/notifications/unread-count`, {
      headers: {
        cookie: outboundCookie,
        ...(locals.sessionToken ? { authorization: `Bearer ${locals.sessionToken}` } : {}),
      },
    });
    if (response.ok) {
      const data = await response.json();
      notificationUnreadCount = Number(data?.count ?? 0);
    }
  } catch {
    notificationUnreadCount = 0;
  }
}
---

<BaseWebLayout {...props} notificationUnreadCount={notificationUnreadCount}>
  <slot />
</BaseWebLayout>
