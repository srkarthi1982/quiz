---
import { actions } from "astro:actions";
import { AvBreadcrumb, AvContainer, AvPageHeader } from "@ansiversa/components";
import BookmarksEmpty from "../components/bookmarks/BookmarksEmpty.astro";
import BookmarksList from "../components/bookmarks/BookmarksList.astro";
import AppShell from "../layouts/AppShell.astro";

const user = Astro.locals.user;
const rootAppUrl = Astro.locals.rootAppUrl ?? "https://ansiversa.com";

if (!user) {
  const loginUrl = new URL("/login", rootAppUrl);
  loginUrl.searchParams.set("returnTo", Astro.url.toString());
  return Astro.redirect(loginUrl.toString());
}

const listResult = await Astro.callAction(actions.quiz.listBookmarks, {});
const bookmarkData = (listResult as any)?.data ?? listResult ?? {};
const items = Array.isArray(bookmarkData?.items) ? bookmarkData.items : [];

const title = "Bookmarks - Ansiversa";
const description = "Saved in Quiz";
---

<AppShell title={title} description={description}>
  <section class="av-faq-public__crumb">
    <AvContainer size="default">
      <AvBreadcrumb
        items={[
          { label: "Home", href: "/" },
          { label: "Bookmarks" },
        ]}
      />
    </AvContainer>
  </section>

  <AvPageHeader title="Bookmarks" description="Saved in Quiz" />

  <section class="av-section">
    <AvContainer>
      <div
        x-data="{
          busy: false,
          async toggleBookmarkItem(entityId, label) {
            if (this.busy) return;
            this.busy = true;
            try {
              await fetch('/api/bookmarks/toggle.json', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                  entityType: 'platform',
                  entityId: String(entityId),
                  label: label ?? undefined,
                }),
              });
              window.location.reload();
            } catch (err) {
              console.error(err);
            } finally {
              this.busy = false;
            }
          }
        }"
      >
        {items.length === 0 ? <BookmarksEmpty /> : <BookmarksList items={items} />}
      </div>
    </AvContainer>
  </section>
</AppShell>
