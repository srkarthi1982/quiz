---
import { actions } from "astro:actions";
import { AvBookmarksEmpty, AvBookmarksList, AvBreadcrumb, AvContainer, AvPageHeader } from "@ansiversa/components";
import AppShell from "../layouts/AppShell.astro";

const user = Astro.locals.user;
const rootAppUrl = Astro.locals.rootAppUrl ?? "https://ansiversa.com";

if (!user) {
  const loginUrl = new URL("/login", rootAppUrl);
  loginUrl.searchParams.set("returnTo", Astro.url.toString());
  return Astro.redirect(loginUrl.toString());
}

const listResult = await Astro.callAction(actions.quiz.listBookmarks, {});
const bookmarkData = (listResult as any)?.data ?? listResult ?? {};
const items = Array.isArray(bookmarkData?.items) ? bookmarkData.items : [];
const bookmarkListItems = items.map((item: any) => ({
  title: item.platformTitle,
  subtitle: item.platformQCount ? `${item.platformQCount.toLocaleString()} questions` : "Questions unavailable",
  description: item.platformDescription ?? "",
  href: `/quiz?platformId=${item.entityId}`,
  rightSlot: {
    active: true,
    activeExpr: "true",
    title: "Save bookmark",
    activeTitle: "Remove bookmark",
    size: "sm" as const,
    onClick: `toggleBookmarkItem('${String(item.entityId).replace(/'/g, "\\'")}', ${JSON.stringify(item.platformTitle)})`,
  },
}));

const title = "Bookmarks - Ansiversa";
const description = "Saved in Quiz";
---

<AppShell title={title} description={description}>
  <section class="av-faq-public__crumb">
    <AvContainer size="default">
      <AvBreadcrumb
        items={[
          { label: "Home", href: "/" },
          { label: "Bookmarks" },
        ]}
      />
    </AvContainer>
  </section>

  <AvPageHeader title="Bookmarks" description="Saved in Quiz" />

  <section class="av-section">
    <AvContainer>
      <div
        x-data="{
          busy: false,
          async toggleBookmarkItem(entityId, label) {
            if (this.busy) return;
            this.busy = true;
            try {
              await fetch('/api/bookmarks/toggle.json', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                  entityType: 'platform',
                  entityId: String(entityId),
                  label: label ?? undefined,
                }),
              });
              window.location.reload();
            } catch (err) {
              console.error(err);
            } finally {
              this.busy = false;
            }
          }
        }"
      >
        {items.length === 0 ? <AvBookmarksEmpty /> : <AvBookmarksList items={bookmarkListItems} />}
      </div>
    </AvContainer>
  </section>
</AppShell>
